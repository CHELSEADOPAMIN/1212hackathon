è¿™æ˜¯ä¸€ä¸ªåŸºäº **Vercel AI SDK (v5)** å’Œ **MongoDB Atlas Vector Search** çš„åŒå‘ RAG æ¨èç³»ç»Ÿå¼€å‘æ–¹æ¡ˆã€‚

æˆ‘å·²é€šè¿‡ `context7MCP` (Web Search) éªŒè¯äº†ä»¥ä¸‹å…³é”®ç‚¹ï¼š
1.  **å…¼å®¹æ€§**ï¼šVercel AI SDK (`ai` v5) ä¸ MongoDB Node.js Driver (v6/v7) ç»“åˆæ˜¯ç›®å‰çš„æœ€ä½³å®è·µï¼Œæ”¯æŒé€šè¿‡ `embed` å‡½æ•°ç”Ÿæˆå‘é‡ï¼Œå¹¶é€šè¿‡åŸç”Ÿ Aggregation Pipeline è¿›è¡Œæ£€ç´¢ã€‚
2.  **åŒå‘æ£€ç´¢**ï¼šMongoDB Atlas æ”¯æŒåœ¨ä¸åŒé›†åˆï¼ˆCollectionï¼‰ä¸Šåˆ†åˆ«å»ºç«‹å‘é‡ç´¢å¼•ï¼Œå®Œå…¨æ»¡è¶³â€œäººæ‰¾å²—â€å’Œâ€œå²—æ‰¾äººâ€çš„åŒå‘éœ€æ±‚ã€‚

---

### ğŸ› ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

ç³»ç»Ÿå°†åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒå‘é‡é›†åˆï¼Œé€šè¿‡è¯­ä¹‰ç›¸ä¼¼åº¦è¿›è¡ŒåŒå‘åŒ¹é…ã€‚

| åœºæ™¯ | æºæ•°æ® (Query) | ç›®æ ‡é›†åˆ (Target) | æµç¨‹ (RAG Flow) |
| :--- | :--- | :--- | :--- |
| **å€™é€‰äººçœ‹æœºä¼š** | å€™é€‰äººç”»åƒ (ç®€å†+GitHub) | `jobs` é›†åˆ | 1. `embed(å€™é€‰äººç”»åƒ)`<br>2. Search `jobs`<br>3. LLM ç”Ÿæˆæ¨èç†ç”± |
| **å…¬å¸æœäººæ‰** | èŒä½æè¿° (JD) | `candidates` é›†åˆ | 1. `embed(JD)`<br>2. Search `candidates`<br>3. LLM ç”ŸæˆåŒ¹é…åˆ†æ |

---

### ğŸ“‹ é˜¶æ®µä¸€ï¼šå‰æœŸé…ç½® (éœ€è¦ä½ æ‰‹åŠ¨æ“ä½œ)

åœ¨å¼€å§‹ä»£ç å¼€å‘å‰ï¼Œè¯·åœ¨ MongoDB Atlas æ§åˆ¶å°å®Œæˆä»¥ä¸‹é…ç½®ï¼š

**1. æ•°æ®åº“è®¾ç½®**
*   åˆ›å»ºä¸€ä¸ª Cluster (Free Tier å³å¯)ã€‚
*   åˆ›å»ºæ•°æ®åº“ï¼šå‘½åä¸º `lyrathon`ã€‚
*   åˆ›å»ºä¸¤ä¸ªé›†åˆï¼š`candidates` å’Œ `jobs`ã€‚

**2. åˆ›å»ºå‘é‡ç´¢å¼• (Vector Search Index)**
ä½ éœ€è¦ä¸ºä¸¤ä¸ªé›†åˆ**åˆ†åˆ«**åˆ›å»ºç´¢å¼•ã€‚è¿›å…¥ Atlas -> Atlas Search -> Vector Search -> Create Index (JSON Editor)ã€‚

**é›†åˆï¼š`candidates` çš„ç´¢å¼•é…ç½®**
```json
{
  "fields": [
    {
      "numDimensions": 1536,
      "path": "embedding",
      "similarity": "cosine",
      "type": "vector"
    },
    {
      "path": "role",
      "type": "filter"
    }
  ]
}
```

**é›†åˆï¼š`jobs` çš„ç´¢å¼•é…ç½®**
```json
{
  "fields": [
    {
      "numDimensions": 1536,
      "path": "embedding",
      "similarity": "cosine",
      "type": "vector"
    },
    {
      "path": "location",
      "type": "filter"
    }
  ]
}
```
*æ³¨ï¼š`1536` æ˜¯ OpenAI `text-embedding-3-small` æ¨¡å‹çš„ç»´åº¦ã€‚*

**3. ç¯å¢ƒå˜é‡**
åœ¨ `.env.local` ä¸­æ·»åŠ ï¼š
```bash
MONGODB_URI="ä½ çš„MongoDBè¿æ¥å­—ç¬¦ä¸²"
OPENAI_API_KEY="ä½ çš„OpenAIå¯†é’¥"
```

---

### ğŸ’» é˜¶æ®µäºŒï¼šå¼€å‘æ–¹æ¡ˆ (Step-by-Step)

#### Step 1: æ•°æ®åº“è¿æ¥å•ä¾‹
**æ–‡ä»¶**: `src/lib/db.ts`
ä½¿ç”¨åŸç”Ÿ MongoDB Driver å®ç°å•ä¾‹æ¨¡å¼ï¼Œé¿å… Next.js å¼€å‘ç¯å¢ƒçƒ­é‡è½½å¯¼è‡´è¿æ¥æ•°è¿‡å¤šã€‚

```typescript
import { MongoClient } from 'mongodb';

const uri = process.env.MONGODB_URI!;
let client: MongoClient;
let clientPromise: Promise<MongoClient>;

// ... (æ ‡å‡†çš„ Next.js MongoDB å•ä¾‹ä»£ç )

export default clientPromise;
```

#### Step 2: å®šä¹‰æ•°æ®ç»“æ„
**æ–‡ä»¶**: `src/lib/types.ts`
æˆ‘ä»¬éœ€è¦æ˜ç¡®å­˜å…¥æ•°æ®åº“çš„ç»“æ„ï¼Œç‰¹åˆ«æ˜¯ `embedding` å­—æ®µã€‚

```typescript
export interface Candidate {
  _id?: string;
  name: string;
  skills: string[];
  summary: string;
  // ... å…¶ä»–å­—æ®µ
  embedding: number[]; // å‘é‡æ•°æ®
}

export interface Job {
  _id?: string;
  title: string;
  description: string;
  requirements: string[];
  // ... å…¶ä»–å­—æ®µ
  embedding: number[]; // å‘é‡æ•°æ®
}
```

#### Step 3: æ•°æ®å…¥åº“ (Ingestion)ä¸å‘é‡åŒ–
æˆ‘ä»¬éœ€è¦ä¿®æ”¹ç°æœ‰çš„ onboarding å’Œ post-job æµç¨‹ã€‚ä½¿ç”¨ Vercel AI SDK çš„ `embed` å‡½æ•°ã€‚

**å·¥å…·åº“**: `src/lib/ai/embedding.ts`
```typescript
import { embed } from 'ai';
import { openai } from '@ai-sdk/openai';

export async function generateEmbedding(text: string) {
  const { embedding } = await embed({
    model: openai.embedding('text-embedding-3-small'),
    value: text,
  });
  return embedding;
}
```

*   **å€™é€‰äººå…¥åº“**ï¼šå°† `skills` + `summary` + `role` æ‹¼æ¥æˆå­—ç¬¦ä¸² -> ç”Ÿæˆ Embedding -> å­˜å…¥ `candidates` é›†åˆã€‚
*   **èŒä½å…¥åº“**ï¼šå°† `title` + `description` + `requirements` æ‹¼æ¥ -> ç”Ÿæˆ Embedding -> å­˜å…¥ `jobs` é›†åˆã€‚

#### Step 4: æ£€ç´¢ä¸æ¨è (Retrieval & Generation)
è¿™æ˜¯ RAG çš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªé€šç”¨çš„åŒ¹é…æœåŠ¡ã€‚

**æœåŠ¡**: `src/lib/matching.ts`
åˆ©ç”¨ MongoDB çš„ `$vectorSearch` èšåˆç®¡é“ã€‚

```typescript
// ä¼ªä»£ç ç¤ºä¾‹
export async function findMatchesForCandidate(candidateProfile: string) {
  const vector = await generateEmbedding(candidateProfile);
  
  const pipeline = [
    {
      $vectorSearch: {
        index: "default", // æ³¨æ„ï¼šAtlasä¸­åˆ›å»ºç´¢å¼•æ—¶è‹¥æœªæŒ‡å®šåå­—ï¼Œé»˜è®¤ä¸ºdefault
        path: "embedding",
        queryVector: vector,
        numCandidates: 100,
        limit: 10
      }
    },
    {
      $project: {
        embedding: 0, // ä¸è¿”å›å‘é‡æ•°æ®ï¼Œå‡å°‘ä¼ è¾“é‡
        score: { $meta: "vectorSearchScore" } // è·å–åŒ¹é…åˆ†æ•°
      }
    }
  ];
  
  // æ‰§è¡ŒæŸ¥è¯¢...
}
```

#### Step 5: æ›¿æ¢ Mock æ•°æ®
é€æ­¥å°†ç°æœ‰é¡µé¢ä¸­çš„ Mock æ•°æ®æ›¿æ¢ä¸º API è°ƒç”¨ï¼š
1.  **Candidate Dashboard**: è°ƒç”¨ `api/recommendations/jobs` (æ–°æ¥å£)ã€‚
2.  **Company Discover**: è°ƒç”¨ `api/recommendations/candidates` (æ–°æ¥å£)ã€‚

---

### â“ ç¡®è®¤äº‹é¡¹

1.  **MongoDB Atlas è´¦å·**ï¼šä½ æ˜¯å¦å·²ç»æœ‰è´¦å·å¹¶å‡†å¤‡å¥½åˆ›å»º Clusterï¼Ÿæ˜¯çš„ 
2.  **æ•°æ®è¿ç§»**ï¼šç›®å‰çš„ Mock æ•°æ®æ˜¯å¦éœ€è¦æˆ‘å†™ä¸€ä¸ªè„šæœ¬ä¸€æ¬¡æ€§å¯¼å…¥æ•°æ®åº“ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼Ÿ æ˜¯çš„
3.  **å¼€å‘é¡ºåº**ï¼šå»ºè®®å…ˆæ‰“é€šâ€œæ•°æ®åº“è¿æ¥â€å’Œâ€œèŒä½å‘å¸ƒ(å…¥åº“)â€ï¼Œç„¶åå†åšâ€œåŒ¹é…æ¨èâ€ã€‚ä½ è§‰å¾—å¦‚ä½•ï¼Ÿ æˆ‘åŒæ„

è¯·ç¡®è®¤ä»¥ä¸Šæ–¹æ¡ˆï¼Œæˆ–è€…æå‡ºä½ çš„è°ƒæ•´æ„è§ã€‚ç¡®è®¤ã€‚