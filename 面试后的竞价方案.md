**需求分析与实现方案**

根据您的需求，我们需要将目前“Mock 数据驱动”的流程转变为“真实业务逻辑驱动”的流程，重点打通 **面试完成 -> HR 审查 -> 发送 Offer -> 透明竞争** 这一闭环。

### 核心变更点
1.  **状态流转**：扩展 `MatchStatus` 以支持面试后和 Offer 阶段的状态。
2.  **数据结构**：在 `Match` 模型中增加 `offer` 字段，存储具体的报价信息（数值型），以便进行比价计算。
3.  **透明竞争**：后端实时聚合计算某候选人的“市场最高报价”，并在 HR 端脱敏展示。

---

### 1. 数据库与类型定义 (`src/lib/types.ts` & `src/lib/db/models.ts`)

#### 扩展 MatchStatus
在 `MatchStatus` 中增加以下状态：
```typescript
export type MatchStatus =
  | "company_interested"
  | "candidate_interested"
  | "matched"
  | "interview_pending"
  | "interview_completed" // 新增: 候选人已提交视频，HR待审
  | "offer_pending"       // 新增: HR已发Offer，候选人待处理
  | "offer_accepted"      // 新增: 候选人接受
  | "offer_rejected"      // 新增: 候选人拒绝
  | "rejected"
  | "rejected_by_candidate";
```

#### 扩展 Match 模型
在 `Match` 接口中增加 `offer` 字段。为了实现“比价”，**报价必须是数字**。
```typescript
export interface MatchOffer {
  amount: number;      // 报价数值 (如: 15000)
  currency: string;    // 币种 (默认 "USD" 或 "CNY")
  message?: string;    // HR 留言
  createdAt: Date;
}

export interface Match {
  // ... 现有字段
  offer?: MatchOffer;  // 新增
}
```

---

### 2. 后端 API 开发

#### A. 完善面试完成逻辑 (`src/app/api/interview/complete/route.ts`)
*   **当前逻辑**：仅更新 `Interview` 表状态。
*   **修改后逻辑**：
    1.  更新 `Interview` 表状态为 `completed`，保存视频。
    2.  **同步更新** 关联的 `Match` 表状态为 `interview_completed`。
    3.  这样该候选人就会自动流转到 HR 端 Pipeline 的 "Interview Review" 列表。

#### B. 新增/修改 Offer 接口 (`src/app/api/company/offer/route.ts`)
*   **POST (Create/Update Offer)**:
    *   入参：`matchId`, `amount`, `message`。
    *   逻辑：
        1.  更新 `Match` 状态为 `offer_pending`。
        2.  更新/覆盖 `Match.offer` 字段。
        3.  返回更新后的 Match 数据。

#### C. 透明竞争数据聚合
*   在 `src/app/api/company/pipeline/route.ts` 中，当获取 `offers` 列表时，为每个条目计算竞争数据。
*   **计算逻辑**：
    *   针对当前 `candidateId`，查询 `Match` 集合中所有 `status` 为 `offer_pending` | `offer_accepted` 的记录（排除当前公司的 Match）。
    *   `marketOffer` = `Max(matches.offer.amount)` (所有竞争对手中的最高价)。
    *   `offerCount` = 竞争对手 Offer 数量。
    *   **注意**：只返回统计数字，严格脱敏，不返回竞争公司名称。

---

### 3. 前端页面开发

#### A. 候选人端 (`src/app/candidate/dashboard/applications/page.tsx`)
*   **Offers 区域**：
    *   不再用 mock 逻辑过滤，改为筛选 `status === 'offer_pending'`。
    *   显示真实报价 `offer.amount` 和 HR 留言。
    *   增加 **[接受]** 和 **[拒绝]** 按钮，调用 API 更新状态。
*   **Interviews 区域**：
    *   对于 `interview_completed` 状态，显示“待 HR 审核”。

#### B. HR 端 (`src/app/company/tracker/page.tsx`)
*   **Interviews Tab (审查面试)**：
    *   数据源：筛选 `status === 'interview_completed'` 的 Match。
    *   **播放真实视频**：从关联的 Interview 对象中读取 `recordingUrl`（目前代码里是写死的 mock url）。
    *   **操作**：
        *   [Reject] -> 状态变 `rejected`。
        *   [Make Offer] -> 弹出 Dialog，输入金额（数字）和留言 -> 调用 Offer API。
*   **Offers Tab (透明竞争)**：
    *   数据源：筛选 `status === 'offer_pending'` 的 Match。
    *   **竞争卡片**：
        *   **Market Top Offer**：显示后端返回的 `marketOffer`（如果为 0 或 null，显示“暂无竞争”）。
        *   **Your Offer**：显示当前的 `match.offer.amount`。
        *   **Gap**：计算两者差值，高亮显示是否领先。
    *   **操作**：[Update Offer] -> 再次调用 Offer API 更新金额，实时刷新排名。
    * 除此以外，还需要显示用户目前的 offer 数，offer 价格平均值等数据

---

### 4. 关键确认事项
1.  **薪资格式**：我们将强制要求 HR 输入 **数字** 类型的薪资（年薪或月薪），不再支持 "10k-20k" 这种范围字符串，以确保比价逻辑准确。您是否同意？同意
2.  **Offer 覆盖**：多次出价将直接覆盖上一条 Offer 记录，只保留最新出价。是否同意？同意

**开发注意代码内的文本需要使用英文**
