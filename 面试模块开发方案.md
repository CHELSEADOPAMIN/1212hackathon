# 面试模块开发方案

## 1. 概述
本模块旨在实现一个基于 AI 的自动化面试流程。HR 为候选人设置面试问题后，系统生成面试链接。候选人进入面试页面，与 AI 面试官进行语音交互。面试全程录像并上传，供 HR 后续回顾。

## 2. 核心流程
1.  **设置面试 (HR端)**: HR 在后台company/tracker页面选中候选人，点击 "Setup Interview"，系统接收 `matchId` 和问题数组，创建面试记录。
2.  **查看面试 (候选人端)**: 候选人在 Dashboard 看到即将到来的面试 (Upcoming Interviews)。
3.  **进行面试 (AI交互)**:
    *   候选人进入全屏面试房间。界面简单，仅展示用户自己的画面和面试官的动态图标，正下方一个下一题按钮，右上角一个退出按钮。
    *   系统请求麦克风与摄像头权限，开始**全程录制**。
    *   AI 面试官（语音 + 动态图标）进行开场白。
    *   AI 依次朗读预设问题，候选人作答，候选人自己点击下一题按钮进入下一题。
    *   所有问题结束后，AI 询问 "有什么想问我们的吗？"，下一题按钮变成提交按钮。
    *   面试结束，停止录制，视频文件存到本地，更新面试状态。

## 3. 数据模型设计
在 `src/lib/db/models.ts` 中新增 `Interview` Schema。

```typescript
export interface IInterview extends Document {
  matchId: string; // 关联外部的 Match 记录 
  questions: string[];
  status: 'scheduled' | 'completed';
  recordingUrl?: string; // 视频文件存储路径 (本地 public/uploads/...)
  createdAt: Date;
}
```

*注意：`matchId` 字段类型定义为 `String` 或 `ObjectId`，取决于 `Match` 表的具体实现。为保持灵活性，若 `Match` 表未定义，暂且视为 `String` 或 `Schema.Types.ObjectId` (如果确认为 Mongo ID)。鉴于通常是 Mongo ID，我们将优先使用 `Schema.Types.ObjectId`，但如果 Mock 阶段传来的是字符串 ID，则需兼容。*

## 4. API 接口设计

### 4.1 创建面试
*   **Endpoint**: `POST /api/interview/setup`
*   **Body**: `{ matchId: string, questions: string[] }`
*   **逻辑**: 创建一条状态为 `scheduled` 的 `Interview` 记录。

### 4.2 获取待办面试
*   **Endpoint**: `GET /api/interview/upcoming`
*   **Query**: `userId` (或从 Session 获取)
*   **逻辑**: 查询该用户关联的所有 `Match` (需跨表或 Mock 数据关联)，找到对应的 `scheduled` 状态的 `Interview`。
    *   *Mock 阶段策略*: 由于 `Match` 表逻辑由他人负责，此接口可能需要临时读取 `Application` 表或直接返回针对当前 Mock 用户的模拟数据，待 `Match` 表就绪后替换查询逻辑。

### 4.3 语音合成 (TTS)
*   **Endpoint**: `POST /api/tts`
*   **Body**: `{ text: string }`
*   **逻辑**: 调用 OpenAI `gpt-4o-mini-tts` 模型生成语音流并返回给前端播放。

### 4.4 结束面试 & 上传录像
*   **Endpoint**: `POST /api/interview/complete`
*   **Body**: `FormData` (包含 `file` (video/webm), `interviewId`)
*   **逻辑**:
    1.  接收上传的视频文件。
    2.  保存文件至 `public/uploads/interviews/{interviewId}.webm`。
    3.  更新 `Interview` 记录：`status` -> `completed`, `recordingUrl` -> 文件路径。

## 5. 前端页面开发

### 5.1 HR 面板 (`src/app/company/tracker/page.tsx`)
*   修改 "Setup AI Interview" 按钮逻辑
*   调用 `/api/interview/setup` 接口传递 `matchId` 和问题。

### 5.2 候选人面板 (`src/app/candidate/dashboard/applications/page.tsx`)
*   替换 Mock 数据。
*   调用 `/api/interview/upcoming` 获取真实列表。
*   "Start Interview" 链接指向 `/interview/[interviewId]`。

### 5.3 面试房间 (`src/app/interview/[id]/page.tsx`)
*   **全屏沉浸式 UI**。
*   **AI Avatar**: 中心动态波纹图标。
*   **交互逻辑**:
    *   初始化：获取面试数据，开启摄像头/麦克风。
    *   **MediaRecorder**: 启动全程录制。
    *   **Question Loop**:
        *   Text -> TTS API -> Play Audio.
        *   Wait for user "Next" click.
    *   **Ending**:
        *   Final Q: "Any questions for us?"
        *   Stop Recording -> Upload Blob to `/api/interview/complete`.
        *   Redirect to Dashboard.

## 6. 技术栈细节
*   **DB**: MongoDB (Mongoose)
*   **tts AI**: Vercel AI SDK (`gpt-4o-mini-tts`) https://ai-sdk.dev/docs/ai-sdk-core/speech tts 的技术我们项目已经安装了 ai-sdk，然后里面有 speech 功能,你可以调查文档内容来辅助开发.
*   **Frontend**: React, Lucide Icons, Browser Native MediaRecorder API.
*   **Storage**: Local Filesystem (`public/uploads`) for MVP.
